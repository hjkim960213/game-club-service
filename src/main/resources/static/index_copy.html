<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>GAME CLUB | ë‚´ì „ í†µí•© í¬í„¸</title>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; padding: 30px; background-color: #f0f2f5; color: #1a1a1b; margin: 0; }

        /* ğŸš© ì»¨í…Œì´ë„ˆ ìµœëŒ€ ë„ˆë¹„ë¥¼ ëŠ˜ë ¤ì„œ ê°€ë¡œ ë°°ì¹˜ë¥¼ ì‹œì›í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤ (1000px -> 1300px) */
        .container { max-width: 1300px; margin: 0 auto; background: #ffffff; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }

        .sidebar { position: fixed; right: 25px; top: 120px; display: flex; flex-direction: column; gap: 15px; z-index: 100; }
        .link-btn { padding: 14px; border-radius: 12px; text-decoration: none; color: white; text-align: center; font-weight: 800; font-size: 13px; transition: 0.3s; width: 80px; }
        .youtube { background: linear-gradient(45deg, #ff0000, #cc0000); }
        .discord { background: linear-gradient(45deg, #5865F2, #4752c4); }

        /* ğŸš© í•µì‹¬ ë ˆì´ì•„ì›ƒ: ì™¼ìª½(6.5)ê³¼ ì˜¤ë¥¸ìª½(3.5) ë¹„ìœ¨ë¡œ í™”ë©´ì„ ë‚˜ëˆ•ë‹ˆë‹¤ */
        .dashboard-grid { display: grid; grid-template-columns: 6.5fr 3.5fr; gap: 40px; margin-top: 20px; align-items: start; }

        /* í™”ë©´ì´ ì¢ì•„ì§€ë©´(ëª¨ë°”ì¼ ë“±) ìë™ìœ¼ë¡œ ì„¸ë¡œë¡œ ë°°ì¹˜ë˜ë„ë¡ ë°˜ì‘í˜• ì²˜ë¦¬ */
        @media (max-width: 1000px) {
            .dashboard-grid { grid-template-columns: 1fr; }
        }

        /* ìƒë‹¨ í—¤ë” ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .header-section { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #f0f2f5; padding-bottom: 20px; margin-bottom: 20px; }
        .header-section h1 { margin: 0; }

        .leaderboard-card { background: #fff; border-radius: 16px; overflow: hidden; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; text-align: center; }
        th { background-color: #1a1a1b; color: #fff; padding: 18px; }
        td { padding: 20px; border-bottom: 1px solid #f0f0f0; }
        .rank-1 { color: #ffbb00; font-weight: 900; background: rgba(255, 187, 0, 0.05); }
        .pts-column { font-size: 20px; font-weight: 900; color: #007bff; }
        .badge { padding: 6px 12px; border-radius: 30px; font-size: 12px; font-weight: bold; color: white; display: inline-block; min-width: 70px; }
        .status-finished { background: #10b981; }
        .status-scheduled { background: #94a3b8; }

        /* ê´€ë¦¬ì ë„êµ¬ ìŠ¤íƒ€ì¼ */
        .admin-only { display: none; margin-top: 40px; padding: 30px; background: #fff1f1; border: 2px dashed #ff4d4f; border-radius: 20px; }
        button { padding: 10px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-main { background: #007bff; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        input { padding: 12px; border: 2px solid #eee; border-radius: 10px; margin-bottom: 10px; }

        /* ğŸš© ì±„íŒ…ì°½ ë””ìì¸ì„ ì˜¤ë¥¸ìª½ ì˜ì—­ì— ë§ê²Œ í‚¤ìš°ê³  ë‹¤ë“¬ì—ˆìŠµë‹ˆë‹¤ */
        .chat-container { background: #fdfdfd; border: 1px solid #eee; border-radius: 15px; padding: 20px; height: 100%; display: flex; flex-direction: column; }
        #chat-window { flex: 1; min-height: 500px; max-height: 600px; overflow-y: scroll; margin-bottom: 15px; padding-right: 10px; }
        #chat-window::-webkit-scrollbar { width: 8px; }
        #chat-window::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <a href="https://www.youtube.com/@welcomevolta" target="_blank" class="link-btn youtube">ìœ íŠœë¸Œ</a>
    <a href="https://discord.gg/cPeJNTEgWU" target="_blank" class="link-btn discord">ë””ìŠ¤ì½”ë“œ</a>
</div>

<div class="container">
    <div id="login-section">
        <h1 style="text-align:center;">ğŸ® GAME CLUB PORTAL</h1>
        <div style="text-align:center; margin-top:50px;">
            <input type="text" id="nickInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥"><br>
            <button class="btn-main" onclick="guestLogin()">ê²ŒìŠ¤íŠ¸ ì…ì¥</button>
            <hr style="margin:30px 0">
            <input type="text" id="adminId" placeholder="ì•„ì´ë””"><br>
            <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸"><br>
            <button style="background:#333; color:white;" onclick="adminLogin()">ìš´ì˜ì§„ ë¡œê·¸ì¸</button>
        </div>
    </div>

    <div id="main-content" style="display:none;">
        <div class="header-section">
            <div>
                <h1>ğŸ† ë¦¬ê·¸ ìˆœìœ„í‘œ <small style="font-size:12px; color:#999;">(5ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ )</small></h1>
                <p id="userDisplay" style="font-weight:bold; color:#007bff; margin: 10px 0 0 0;"></p>
            </div>
            <button class="btn-danger" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div class="dashboard-grid">

            <div class="left-col">
                <div class="leaderboard-card">
                    <table>
                        <thead>
                        <tr><th>ìˆœìœ„</th><th>íŒ€ ì´ë¦„</th><th>ìŠ¹</th><th>ë¬´</th><th>íŒ¨</th><th>ìŠ¹ì </th></tr>
                        </thead>
                        <tbody id="leaderboardBody"></tbody>
                    </table>
                </div>

                <div id="admin-tab" class="admin-only">
                    <h2 style="color:#ef4444; margin-top:0;">ğŸ› ï¸ ìš´ì˜ì§„ ê´€ë¦¬ ë„êµ¬</h2>
                    <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #ddd;">
                        <h4 style="margin-top:0">ğŸš© ì‹ ê·œ íŒ€ ìƒì„±</h4>
                        <div style="display: flex; gap:10px">
                            <input type="text" id="newTeamName" placeholder="ìƒˆ íŒ€ ì´ë¦„" style="flex:1; margin:0">
                            <button class="btn-main" onclick="createTeam()" style="width: 120px;">íŒ€ ë§Œë“¤ê¸°</button>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <button class="btn-main" onclick="genSchedule()">ğŸ“… ëŒ€ì§„í‘œ ìƒì„±</button>
                        <button class="btn-danger" onclick="resetAll()">âš ï¸ ë°ì´í„° ì™„ì „ ì´ˆê¸°í™”</button>
                    </div>
                    <div id="matchList"></div>
                </div>
            </div>

            <div class="right-col">
                <div class="chat-container">
                    <h3 style="margin-top: 0;">ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ… <span style="font-size:12px; color:#ff4d4f;">â— LIVE</span></h3>
                    <div id="chat-window"></div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="chatInput" style="flex:1; margin:0" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                        <button class="btn-main" onclick="sendMsg()">ì „ì†¡</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    let socket;
    let myNickname = "";
    let myColor = "";

    // ğŸš© [ì™„ë²½ ê°œì„ ] í™©ê¸ˆê°(Golden Angle)ì„ ì´ìš©í•˜ì—¬ ë‹‰ë„¤ì„ì´ í•œ ê¸€ìë§Œ ë‹¬ë¼ë„ ìƒ‰ìƒì„ í™• ì°¢ì–´ë²„ë¦¬ëŠ” ê³µì‹
    function getUniqueColor(nickname) {
        let sum = 0;
        for (let i = 0; i < nickname.length; i++) {
            // ê° ê¸€ìì˜ ìœ ë‹ˆì½”ë“œ ê°’ì„ ì „ë¶€ ë”í•©ë‹ˆë‹¤.
            sum += nickname.charCodeAt(i);
        }

        // 137.5ëŠ” ìì—°ê³„ì˜ í™©ê¸ˆê°ì…ë‹ˆë‹¤.
        // ê²ŒìŠ¤íŠ¸1ê³¼ ê²ŒìŠ¤íŠ¸2ì²˜ëŸ¼ í•©ê³„ê°€ 1 ì°¨ì´ ë‚˜ë”ë¼ë„, ìƒ‰ìƒí™˜ì„ 137.5ë„ì”© í™• ëŒë ¤ë²„ë ¤ì„œ ì „í˜€ ë‹¤ë¥¸ ìƒ‰ì´ ë‚˜ì˜µë‹ˆë‹¤.
        const hue = (sum * 137.5) % 360;

        // ë°°ê²½ì´ í°ìƒ‰ì´ë¯€ë¡œ ì±„ë„(75%)ì™€ ëª…ë„(45%)ë¥¼ ê³ ì •í•˜ì—¬ ê°€ë…ì„± ì¢‹ê³  ì˜ˆìœ ìƒ‰ìœ¼ë¡œë§Œ ë½‘ìŠµë‹ˆë‹¤.
        return `hsl(${hue}, 75%, 45%)`;
    }

    async function loadLeaderboard() {
        try {
            const res = await fetch('/teams?_t=' + new Date().getTime());
            const teams = await res.json();
            const body = document.getElementById('leaderboardBody');
            body.innerHTML = teams.map((t, i) => `
                <tr class="${i < 3 ? 'rank-' + (i + 1) : ''}">
                    <td>${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : i + 1}</td>
                    <td style="font-weight:bold">${t.teamName}</td>
                    <td>${t.wins}</td><td>${t.draws}</td><td>${t.losses}</td>
                    <td class="pts-column">${t.totalPoints}</td>
                </tr>
            `).join('');
        } catch(e) { console.error("ìˆœìœ„í‘œ ê°±ì‹  ì—ëŸ¬", e); }
    }

    async function loadMatches() {
        const res = await fetch('/matches?_t=' + new Date().getTime());
        const matches = await res.json();
        const listDiv = document.getElementById('matchList');
        listDiv.innerHTML = '<h3>ğŸ ê²½ê¸° ê²°ê³¼ ìˆ˜ì •</h3>';
        matches.forEach(m => {
            const div = document.createElement('div');
            div.style.cssText = "padding:15px; background:#fff; margin-bottom:10px; border-radius:10px; border:1px solid #ddd; display:flex; align-items:center; gap:10px;";
            div.innerHTML = `
                <span class="badge ${m.status === 'FINISHED' ? 'status-finished' : 'status-scheduled'}">${m.status === 'FINISHED' ? 'ì¢…ë£Œ' : 'ì˜ˆì •'}</span>
                <b style="flex:1">${m.homeTeamName} vs ${m.awayTeamName}</b>
                <input type="number" id="h-${m.id}" value="${m.homeScore}" style="width:50px; margin:0; text-align:center;"> :
                <input type="number" id="a-${m.id}" value="${m.awayScore}" style="width:50px; margin:0; text-align:center;">
                <button onclick="updateResult('${m.id}')" style="background:#ffbb00; padding:8px 15px;">ë°˜ì˜</button>
            `;
            listDiv.appendChild(div);
        });
    }

    async function createTeam() {
        const nameInput = document.getElementById('newTeamName');
        const name = nameInput.value.trim();
        if (!name) return alert("íŒ€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");

        try {
            const res = await fetch(`/create-team?name=${encodeURIComponent(name)}`);
            const msg = await res.text();

            await loadLeaderboard();
            nameInput.value = '';

            setTimeout(() => { alert(msg); }, 50);

        } catch (err) {
            console.error("í†µì‹  ì—ëŸ¬", err);
            alert("ì„œë²„ì™€ í†µì‹ í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ğŸš© ì„œë²„ë¡œ ë‹‰ë„¤ì„ì„ ë³´ë‚´ê³ , ì‹¤ì‹œê°„ ëª…ë‹¨ì„ ë°›ì•„ ì²˜ë¦¬í•˜ë„ë¡ ì§„í™”ëœ ì±„íŒ… í•¨ìˆ˜
    function connectChat(nickname, role) {
        myNickname = nickname;
        myColor = (role === 'ADMIN') ? '#ff4d4f' : getUniqueColor(nickname);

        // 1. ì„œë²„ì— ì—°ê²°í•  ë•Œ ë‚´ ë‹‰ë„¤ì„ì„ ì£¼ì†Œ ë’¤ì— ë‹¬ì•„ì„œ ë³´ëƒ…ë‹ˆë‹¤.
        socket = new WebSocket(`ws://${location.host}/ws/chat?nickname=${encodeURIComponent(nickname)}`);

        socket.onmessage = (e) => {
            // 2. ë§Œì•½ ì„œë²„ê°€ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ëª…ë‹¨([USER_LIST])ì´ë¼ë©´?
            if (e.data.startsWith("[USER_LIST]")) {
                // ìƒë‹¨ì— ìˆë˜ 'ğŸ‘‹ í¬ì¤€ë‹˜ ì ‘ì† ì¤‘' ê¸€ì”¨ë¥¼ ì‹¤ì‹œê°„ ëª…ë‹¨ìœ¼ë¡œ ë®ì–´ì”ë‹ˆë‹¤!
                document.getElementById('userDisplay').innerText = e.data.replace("[USER_LIST]", "ğŸŸ¢ ì‹¤ì‹œê°„ ");
                return; // ì±„íŒ…ì°½ì—ëŠ” ì•ˆ ê·¸ë¦¬ê²Œ ì—¬ê¸°ì„œ ëëƒ…ë‹ˆë‹¤.
            }

            // 3. ì¼ë°˜ ì±„íŒ… ë©”ì‹œì§€ë¼ë©´ í‰ì†Œì²˜ëŸ¼ í™”ë©´ì— ê·¸ë¦½ë‹ˆë‹¤.
            const win = document.getElementById('chat-window');
            const div = document.createElement('div');
            div.style.marginBottom = "10px";
            div.innerHTML = e.data;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        };
    }

    function sendMsg() {
        const input = document.getElementById('chatInput');
        if (!input.value || !socket) return;
        const msg = `<strong style="color:${myColor}">${myNickname}</strong>: ${input.value}`;
        socket.send(msg);
        input.value = '';
    }

    async function updateResult(id) {
        await fetch(`/update-result?matchId=${id}&homeScore=${document.getElementById(`h-${id}`).value}&awayScore=${document.getElementById(`a-${id}`).value}`);
        await loadLeaderboard();

        setTimeout(() => {
            alert("ê²°ê³¼ ë°˜ì˜ ì™„ë£Œ!");
        }, 50);
    }

    async function resetAll() {
        if (!confirm("âš ï¸ ëª¨ë“  ë°ì´í„°(íŒ€, ê²½ê¸°)ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?")) return;
        const res = await fetch('/reset-all');
        const msg = await res.text();
        alert(msg);
        location.reload();
    }

    async function genSchedule() {
        const res = await fetch('/generate-schedule');
        const msg = await res.text();
        alert(msg);
        loadMatches();
    }

    async function checkAuth() {
        const res = await fetch('/api/me');
        if (res.ok) {
            const user = await res.json();
            if (user && user.nickname) {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('userDisplay').innerText = `ğŸ‘‹ ${user.nickname}ë‹˜ ì ‘ì† ì¤‘`;
                if (user.role === 'ADMIN') document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');

                connectChat(user.nickname, user.role);

                loadLeaderboard(); loadMatches();
            }
        }
    }

    async function guestLogin() {
        const n = document.getElementById('nickInput').value;
        await fetch(`/api/login/guest?nickname=${encodeURIComponent(n)}`, { method: 'POST' });
        checkAuth();
    }

    async function adminLogin() {
        const id = document.getElementById('adminId').value;
        const pw = document.getElementById('adminPw').value;
        const res = await fetch(`/api/login/admin?loginId=${id}&password=${pw}`, { method: 'POST' });
        if (res.ok) checkAuth(); else alert("ì•„ì´ë””/ë¹„ë²ˆ í‹€ë¦¼");
    }

    async function logout() {
        await fetch('/api/logout', { method: 'POST' });
        location.href = "/";
    }

    setInterval(() => {
        if (document.getElementById('main-content').style.display === 'block') loadLeaderboard();
    }, 5000);

    window.onload = checkAuth;
    document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMsg(); });
</script>
</body>
</html>