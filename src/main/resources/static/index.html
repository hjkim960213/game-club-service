<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë³¼íƒ€í´ëŸ½ | ë‚´ì „ ì „ì  í¬íƒˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        :root {
            --bg-color: #0f172a; --card-bg: rgba(30, 41, 59, 0.7); --text-main: #f8fafc;
            --text-muted: #94a3b8; --border-color: rgba(255, 255, 255, 0.1); --primary: #3b82f6;
            --primary-hover: #2563eb; --win-color: #10b981; --lose-color: #ef4444;
            --draw-color: #64748b; --gold: #fbbf24;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background: radial-gradient(circle at top right, #1e293b, #0f172a); color: var(--text-main); margin: 0; padding: 0; min-height: 100vh; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        .navbar { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .nav-logo { font-size: 1.5rem; font-weight: 900; color: white; display: flex; align-items: center; gap: 10px; } .nav-logo span { color: var(--primary); }
        .nav-links { display: flex; gap: 15px; }
        .nav-links a { color: var(--text-muted); text-decoration: none; font-size: 14px; font-weight: 600; padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.05); transition: 0.2s; }
        .nav-links a:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-links a.btn-fconline { background: #00194b; color: white; border: 1px solid #1a3673; }

        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        #notice-bar { display: none; background: linear-gradient(135deg, #ef4444, #b91c1c); color: white; padding: 12px 20px; border-radius: 12px; margin-bottom: 25px; font-weight: bold; text-align: center; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        #login-section { max-width: 400px; margin: 100px auto; text-align: center; }
        .input-group { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
        input, textarea { width: 100%; padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border-color); background: rgba(0,0,0,0.2); color: white; font-size: 15px; outline: none; transition: 0.2s; font-family: 'Pretendard', sans-serif;}
        input:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        button.btn-main, button.btn-danger { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: 800; font-size: 15px; cursor: pointer; transition: 0.2s; color: white; }
        button.btn-main { background: linear-gradient(135deg, var(--primary), var(--primary-hover)); }
        button.btn-main:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4); }
        button.btn-danger { background: var(--lose-color); }

        .glass-card { background: var(--card-bg); backdrop-filter: blur(16px); border: 1px solid var(--border-color); border-radius: 16px; padding: 25px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 350px; gap: 30px; align-items: start; }
        @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr; } }

        .tab-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 12px; }
        .tab-btn { flex: 1; min-width: 120px; padding: 12px; border-radius: 8px; border: none; background: transparent; color: var(--text-muted); font-weight: 700; font-size: 1.05rem; cursor: pointer; transition: 0.3s; }
        .tab-btn:hover { color: white; background: rgba(255,255,255,0.05); }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }

        table { width: 100%; border-collapse: collapse; text-align: center; }
        th { color: var(--text-muted); padding: 15px; border-bottom: 1px solid var(--border-color); font-size: 13px; letter-spacing: 1px; }
        td { padding: 18px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 15px; font-weight: 500; }
        tr:hover td { background: rgba(255,255,255,0.03); }
        .pts-column { color: var(--primary); font-size: 1.2rem; font-weight: 900; }

        .admin-only { display: none; margin-top: 30px; padding: 20px; background: rgba(239, 68, 68, 0.05); border: 2px dashed #ff4d4f; border-radius: 16px; }

        .chat-container { display: flex; flex-direction: column; height: 600px; padding: 20px; }
        .chat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;}
        #chat-window { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-right: 10px; margin-bottom: 15px;}
        .chat-msg { background: rgba(0,0,0,0.2); padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.4; }
        .chat-input-wrapper { display: flex; gap: 10px; }
        .chat-input-wrapper input { padding: 12px; margin: 0; flex: 1;}
        .chat-input-wrapper button { width: 80px; padding: 12px; }

        /* ë©¤ë²„ ì†Œê°œ UI */
        .members-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .member-card { background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; text-align: center; position: relative; transition: 0.3s; }
        .member-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2); }
        .member-pos { display: inline-block; padding: 4px 10px; background: rgba(59, 130, 246, 0.2); color: var(--primary); border-radius: 20px; font-size: 12px; font-weight: 900; margin-bottom: 10px; }
        .member-name { font-size: 1.2rem; font-weight: 800; margin-bottom: 10px; }
        .member-desc { font-size: 13px; color: var(--text-muted); line-height: 1.5; }
        .btn-delete-member { position: absolute; top: 10px; right: 10px; background: var(--lose-color); color: white; border: none; border-radius: 6px; padding: 4px 8px; font-size: 11px; cursor: pointer; display: none; }

        /* ì¹´í…Œê³ ë¦¬/ê²Œì‹œíŒ ë“œë˜ê·¸ ì•¤ ë“œë¡­ */
        .category-bar { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; }
        .cat-wrapper { position: relative; display: inline-block; cursor: grab; }
        .cat-wrapper.sortable-ghost { opacity: 0.4; }
        .category-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border-color); background: rgba(255,255,255,0.05); color: var(--text-muted); font-weight: bold; cursor: pointer; white-space: nowrap; }
        .category-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .cat-delete-btn {
            position: absolute; top: -5px; right: -5px; background: var(--lose-color); color: white;
            border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; border: none; padding: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .board-post-row { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; align-items: center;}
        .board-post-row:hover { background: rgba(255,255,255,0.05); }
        .post-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .post-meta { font-size: 12px; color: var(--text-muted); display: flex; gap: 15px; align-items: center;}
        .post-content-view { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; margin-top: 10px; display: none; border: 1px solid var(--border-color); font-size: 14px; line-height: 1.6;}

        /* ì „ì  ì¹´ë“œ */
        .match-card { background: rgba(0,0,0,0.2); border-radius: 12px; margin-bottom: 25px; overflow: hidden; border: 1px solid var(--border-color); }
        .match-header { background: rgba(255,255,255,0.03); padding: 10px 20px; font-size: 13px; color: var(--text-muted); border-bottom: 1px solid var(--border-color); text-align: center; font-weight: bold;}
        .match-teams { display: grid; grid-template-columns: 1fr 1fr; }
        @media (max-width: 768px) { .match-teams { grid-template-columns: 1fr; } }

        .team-box { padding: 20px; }
        .team-box.win { background: linear-gradient(90deg, rgba(16, 185, 129, 0.05), transparent); border-left: 4px solid var(--win-color); }
        .team-box.lose { background: linear-gradient(90deg, rgba(239, 68, 68, 0.05), transparent); border-left: 4px solid var(--lose-color); }
        .team-box.draw { border-left: 4px solid var(--draw-color); }

        .team-title { font-size: 1.1rem; font-weight: 800; margin-bottom: 15px; }
        .win .team-title { color: var(--win-color); } .lose .team-title { color: var(--lose-color); }

        .player-row { display: grid; grid-template-columns: 3fr 1fr 2fr; align-items: center; padding: 8px 10px; border-radius: 6px; margin-bottom: 5px; font-size: 13px; }
        .player-row:hover { background: rgba(255,255,255,0.05); }
        .player-row.is-me { background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.4); }

        .p-name { font-weight: bold; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .p-rating { color: var(--gold); font-weight: 800; text-align: center; }
        .p-stats { color: var(--text-muted); text-align: right; display: flex; justify-content: flex-end; gap: 10px;}
    </style>
</head>
<body>

<div class="navbar" id="top-nav" style="display:none;">
    <div class="nav-logo">âš½ VOLTA<span>CLUB</span></div>
    <div class="nav-links">
        <a href="https://www.youtube.com/@welcomevolta" target="_blank">ğŸ“º ìœ íŠœë¸Œ</a>
        <a href="https://discord.gg/cPeJNTEgWU" target="_blank">ğŸ‘¾ ë””ìŠ¤ì½”ë“œ</a>
        <a href="https://open.kakao.com/o/gO6ji4ye" target="_blank">ğŸ’¬ ì¹´í†¡</a>
        <a href="https://fconline.nexon.com/main/index" target="_blank" class="btn-fconline">FC ê³µì‹í™ˆ</a>
        <button onclick="logout()" style="background:transparent; border:1px solid #ef4444; color:#ef4444; padding:6px 12px; border-radius:8px; cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</div>

<div class="container">
    <div id="notice-bar">ğŸ“¢ <span id="notice-text"></span></div>

    <div id="login-section" class="glass-card">
        <h1 style="margin-top:0; font-size:1.8rem;">âš½ VOLTA <span style="color:var(--primary)">CLUB</span></h1>
        <p style="color:var(--text-muted); font-size:14px; margin-bottom:30px;">í¬íƒˆì— ì…ì¥í•˜ê¸° ìœ„í•´ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”</p>
        <div class="input-group">
            <input type="text" id="nickInput" placeholder="FCì˜¨ë¼ì¸ ë‹‰ë„¤ì„" onkeypress="if(event.key==='Enter') guestLogin()">
            <button class="btn-main" onclick="guestLogin()">í¬íƒˆ ì…ì¥í•˜ê¸°</button>
        </div>
        <div style="margin: 25px 0; display:flex; align-items:center; color:var(--text-muted); font-size:12px;">
            <div style="flex:1; height:1px; background:var(--border-color);"></div><span style="padding:0 10px;">ADMIN ONLY</span><div style="flex:1; height:1px; background:var(--border-color);"></div>
        </div>
        <div class="input-group">
            <input type="text" id="adminId" placeholder="ê´€ë¦¬ì ID">
            <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeypress="if(event.key==='Enter') adminLogin()">
            <button class="btn-main" style="background:#334155;" onclick="adminLogin()">ìš´ì˜ì§„ ë¡œê·¸ì¸</button>
        </div>
    </div>

    <div id="main-content" style="display:none;">
        <div class="dashboard-grid">

            <div class="left-section">
                <div class="tab-container">
                    <button id="btn-tab-volta" class="tab-btn active" onclick="switchTab('volta')">ğŸ” ì „ì  ê²€ìƒ‰</button>
                    <button id="btn-tab-members" class="tab-btn" onclick="switchTab('members')">ğŸ‘¥ ë©¤ë²„ ì†Œê°œ</button>
                    <button id="btn-tab-board" class="tab-btn" onclick="switchTab('board')">ğŸ“ í´ëŸ½ ê²Œì‹œíŒ</button>
                    <button id="btn-tab-leaderboard" class="tab-btn" onclick="switchTab('leaderboard')">ğŸ† ìˆœìœ„/ìš´ì˜</button>
                </div>

                <div id="tab-volta" class="glass-card">
                    <div style="display: flex; gap: 10px; margin-bottom: 25px;">
                        <input type="text" id="voltaSearchInput" placeholder="FCì˜¨ë¼ì¸ ë‹‰ë„¤ì„ ê²€ìƒ‰" style="flex:1; font-size:15px; background:rgba(0,0,0,0.3); border-color:rgba(255,255,255,0.2);" onkeypress="if(event.key==='Enter') searchVolta()">
                        <button class="btn-main" style="width:100px; padding:0;" onclick="searchVolta()">ê²€ìƒ‰</button>
                    </div>
                    <div id="voltaResultContainer"><div style="text-align:center; padding: 60px 0; color:var(--text-muted);"><span style="font-size:3rem; display:block; margin-bottom:15px;">ğŸ®</span>ìµœê·¼ 20ê²½ê¸° 4v4 ìŠ¤íƒ¯ì´ ë¶„ì„ë©ë‹ˆë‹¤.</div></div>
                </div>

                <div id="tab-members" class="glass-card" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h2 style="margin:0;">ğŸ‘¥ ì–´ì„œì™€ ë©¤ë²„ë¥¼ ì†Œê°œí•©ë‹ˆë‹¤!</h2>
                    </div>
                    <p style="color:var(--text-muted); font-size:14px; margin-top:0;">ìš°ë¦¬ í´ëŸ½ì˜ ìë‘ìŠ¤ëŸ¬ìš´ ë©¤ë²„ë“¤ì…ë‹ˆë‹¤.</p>

                    <div class="admin-only" style="margin-bottom:20px; padding:15px; background:rgba(59,130,246,0.1); border:1px solid rgba(59,130,246,0.3); border-radius:10px;">
                        <h4 style="margin:0 0 10px 0; color:var(--primary);">â• ë©¤ë²„ ì¶”ê°€ (ìš´ì˜ì§„)</h4>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <input type="text" id="newMemNick" placeholder="ë‹‰ë„¤ì„" style="flex:1;">
                            <input type="text" id="newMemPos" placeholder="ì£¼ í¬ì§€ì…˜ (ì˜ˆ: ST)" style="flex:1;">
                        </div>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="newMemDesc" placeholder="í•œì¤„í‰ ì†Œê°œ" style="flex:3;">
                            <button class="btn-main" style="flex:1; padding:0;" onclick="addMember()">ë“±ë¡í•˜ê¸°</button>
                        </div>
                    </div>
                    <div id="membersGrid" class="members-grid"></div>
                </div>

                <div id="tab-board" class="glass-card" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <div class="category-bar" id="categoryBar" style="flex:1; margin-bottom:0;"></div>
                        <button class="btn-main" style="width:120px; padding:10px; margin-left:15px;" onclick="toggleWriteForm()">âœï¸ ê¸€ì“°ê¸°</button>
                    </div>

                    <div class="admin-only" style="display:flex; gap:10px; margin-bottom:20px; background:rgba(239, 68, 68, 0.05); padding:10px; border-radius:8px;">
                        <input type="text" id="newCatName" placeholder="ìƒˆë¡œìš´ ê²Œì‹œíŒ íƒ­ ì´ë¦„" style="flex:1; padding:10px;">
                        <button class="btn-main" style="width:100px; padding:0;" onclick="addCategory()">íƒ­ ìƒì„±</button>
                    </div>

                    <div id="writeForm" style="display:none; background:rgba(0,0,0,0.2); padding:20px; border-radius:12px; border:1px solid var(--border-color); margin-bottom:20px;">
                        <input type="text" id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" style="margin-bottom:10px;">
                        <textarea id="postContent" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì´ë¯¸ì§€ ì²¨ë¶€ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤!)" rows="5" style="margin-bottom:10px; resize:vertical;"></textarea>
                        <div style="display:flex; gap:10px; justify-content:flex-end;">
                            <button class="btn-danger" style="width:100px; padding:10px;" onclick="toggleWriteForm()">ì·¨ì†Œ</button>
                            <button class="btn-main" style="width:100px; padding:10px;" onclick="addPost()">ë“±ë¡</button>
                        </div>
                    </div>
                    <div id="postListContainer" style="border-top:1px solid var(--border-color);"></div>
                </div>

                <div id="tab-leaderboard" class="glass-card" style="display:none;">
                    <div class="leaderboard-wrapper">
                        <table>
                            <thead><tr><th>RANK</th><th>TEAM</th><th>W</th><th>D</th><th>L</th><th>PTS</th></tr></thead>
                            <tbody id="leaderboardBody"></tbody>
                        </table>
                    </div>
                    <div id="admin-tab" class="admin-only" style="margin-top:40px;">
                        <h3 style="color:var(--lose-color); border-bottom:1px solid var(--border-color); padding-bottom:10px; margin-top:0;">ğŸ› ï¸ ë‚´ì „ ì–´ë“œë¯¼ ë„êµ¬</h3>
                        <div style="margin-bottom: 20px;"><h4 style="margin:0 0 10px 0;">ğŸš© ì‹ ê·œ íŒ€ ë“±ë¡</h4><div style="display: flex; gap:10px"><input type="text" id="newTeamName" placeholder="íŒ€ ì´ë¦„ ì…ë ¥"><button class="btn-main" style="width:100px; padding:0;" onclick="createTeam()">ìƒì„±</button></div></div>
                        <div style="display:flex; gap:10px; margin-bottom:20px;"><button class="btn-main" style="flex:1; background:#10b981;" onclick="genSchedule()">ğŸ“… ëŒ€ì§„í‘œ ìë™ìƒì„±</button><button class="btn-danger" style="flex:1;" onclick="resetAll()">âš ï¸ ì „ì  ì´ˆê¸°í™”</button></div>
                        <div id="matchList"></div>
                    </div>
                </div>

            </div>

            <div class="right-section">
                <div class="glass-card chat-container">
                    <div class="chat-header"><h3 style="margin:0; font-size:1.1rem; display:flex; align-items:center; gap:8px;">ğŸ’¬ ë¼ì´ë¸Œ ì±„íŒ… <span style="width:8px; height:8px; background:var(--lose-color); border-radius:50%; box-shadow:0 0 8px var(--lose-color);"></span></h3><span id="userDisplay" style="font-size:12px; color:var(--primary); font-weight:bold;"></span></div>
                    <div id="chat-window"></div>
                    <div class="chat-input-wrapper">
                        <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeypress="if(event.key==='Enter') sendMsg()">
                        <button class="btn-main" onclick="sendMsg()">ì „ì†¡</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    let socket; let myNickname = ""; let myColor = ""; let myRole = "GUEST";
    const IS_LOCAL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const SERVER_URL = IS_LOCAL ? "localhost:8080" : "game-club-service.onrender.com";
    const API_BASE = IS_LOCAL ? `http://${SERVER_URL}` : `https://${SERVER_URL}`;

    let currentCategoryId = null;

    function getUniqueColor(nickname) {
        let sum = 0; for (let i = 0; i < nickname.length; i++) sum += nickname.charCodeAt(i);
        return `hsl(${(sum * 137.5) % 360}, 80%, 75%)`;
    }

    function switchTab(tabName) {
        ['volta', 'members', 'board', 'leaderboard'].forEach(name => {
            document.getElementById(`tab-${name}`).style.display = name === tabName ? 'block' : 'none';
            document.getElementById(`btn-tab-${name}`).classList.toggle('active', name === tabName);
        });
        if(tabName === 'members') loadMembers();
        if(tabName === 'board' && !currentCategoryId) loadCategories();
    }

    // ==========================================
    // ğŸ‘¥ ë©¤ë²„ ì†Œê°œ
    // ==========================================
    async function loadMembers() {
        try {
            const res = await fetch(`${API_BASE}/api/community/members`);
            const members = await res.json();
            const isAdmin = (myRole === 'ADMIN');
            document.getElementById('membersGrid').innerHTML = members.map(m => `
                <div class="member-card">
                    <button class="btn-delete-member" style="display: ${isAdmin ? 'block' : 'none'};" onclick="deleteMember(${m.id})">ì‚­ì œ</button>
                    <div class="member-pos">${m.position}</div>
                    <div class="member-name">${m.nickname}</div>
                    <div class="member-desc">"${m.description}"</div>
                </div>
            `).join('');
        } catch (e) { }
    }
    async function addMember() {
        const nick = document.getElementById('newMemNick').value.trim(); const pos = document.getElementById('newMemPos').value.trim(); const desc = document.getElementById('newMemDesc').value.trim();
        if(!nick || !pos || !desc) return alert("ë¹ˆì¹¸ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”!");
        await fetch(`${API_BASE}/api/community/members?nickname=${encodeURIComponent(nick)}&position=${encodeURIComponent(pos)}&description=${encodeURIComponent(desc)}`, {method:'POST'});
        document.getElementById('newMemNick').value = ''; document.getElementById('newMemPos').value = ''; document.getElementById('newMemDesc').value = ''; loadMembers();
    }
    async function deleteMember(id) {
        if(confirm("ì •ë§ ì´ ë©¤ë²„ë¥¼ ì‚­ì œí• ê¹Œìš”?")) { await fetch(`${API_BASE}/api/community/members/${id}`, {method:'DELETE'}); loadMembers(); }
    }

    // ==========================================
    // ğŸ“ ê²Œì‹œíŒ ì¹´í…Œê³ ë¦¬ (ë“œë˜ê·¸ ì•¤ ë“œë¡­ & ì‚­ì œ)
    // ==========================================
    let sortableInstance = null;

    async function loadCategories() {
        try {
            const res = await fetch(`${API_BASE}/api/community/categories`);
            const categories = await res.json();
            const bar = document.getElementById('categoryBar');
            const isAdmin = (myRole === 'ADMIN');

            bar.innerHTML = categories.map(c => `
                <div class="cat-wrapper" data-id="${c.id}">
                    <button class="category-btn" id="cat-btn-${c.id}" onclick="selectCategory(${c.id})">${c.name}</button>
                    ${isAdmin ? `<button class="cat-delete-btn" onclick="deleteCategory(${c.id}, event)">âœ–</button>` : ''}
                </div>
            `).join('');

            if(categories.length > 0 && !currentCategoryId) selectCategory(categories[0].id);
            else if (currentCategoryId) selectCategory(currentCategoryId);

            if(isAdmin) {
                if(sortableInstance) sortableInstance.destroy();
                sortableInstance = new Sortable(bar, {
                    animation: 150, ghostClass: 'sortable-ghost',
                    onEnd: function () {
                        const itemEls = bar.querySelectorAll('.cat-wrapper');
                        const newOrderIds = Array.from(itemEls).map(el => el.getAttribute('data-id'));
                        fetch(`${API_BASE}/api/community/categories/reorder`, {
                            method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(newOrderIds)
                        });
                    }
                });
            }
        } catch (e) { }
    }

    async function addCategory() {
        const name = document.getElementById('newCatName').value.trim(); if(!name) return;
        await fetch(`${API_BASE}/api/community/categories?name=${encodeURIComponent(name)}`, {method:'POST'});
        document.getElementById('newCatName').value = ''; loadCategories();
    }
    async function deleteCategory(id, event) {
        event.stopPropagation();
        if(confirm("í•´ë‹¹ íƒ­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì•ˆì— ìˆëŠ” ê¸€ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤!)")) {
            await fetch(`${API_BASE}/api/community/categories/${id}`, {method:'DELETE'});
            if(currentCategoryId === id) currentCategoryId = null; loadCategories();
        }
    }

    function selectCategory(id) {
        currentCategoryId = id;
        document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.getElementById(`cat-btn-${id}`);
        if(activeBtn) activeBtn.classList.add('active');
        loadPosts(id);
    }

    // ==========================================
    // ğŸ“ ê²Œì‹œê¸€ (ì‚­ì œ ê¶Œí•œ ì¶”ê°€)
    // ==========================================
    async function loadPosts(categoryId) {
        try {
            const res = await fetch(`${API_BASE}/api/community/posts?categoryId=${categoryId}`);
            const posts = await res.json();
            const container = document.getElementById('postListContainer');

            if(posts.length === 0) { container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted);">ì•„ì§ ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div>`; return; }

            container.innerHTML = posts.map(p => {
                const date = new Date(p.createdAt).toLocaleDateString();
                const canDelete = (myRole === 'ADMIN' || myNickname === p.authorNickname);
                const delBtnHtml = canDelete ? `<button class="btn-danger" style="padding:4px 8px; font-size:11px; width:auto;" onclick="deletePost(${p.id}, event)">ì‚­ì œ</button>` : '';

                return `
                <div style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <div class="board-post-row" onclick="document.getElementById('post-content-${p.id}').style.display = document.getElementById('post-content-${p.id}').style.display === 'block' ? 'none' : 'block'">
                        <div style="flex:1;">
                            <div class="post-title">${p.title}</div>
                            <div class="post-meta"><span>ğŸ‘¤ ${p.authorNickname}</span><span>ğŸ•’ ${date}</span></div>
                        </div>
                        <div>${delBtnHtml}</div>
                    </div>
                    <div id="post-content-${p.id}" class="post-content-view">${p.content.replace(/\n/g, '<br>')}</div>
                </div>
                `;
            }).join('');
        } catch(e) { }
    }

    function toggleWriteForm() { const form = document.getElementById('writeForm'); form.style.display = form.style.display === 'none' ? 'block' : 'none'; }

    async function addPost() {
        if(!currentCategoryId) return alert("ì¹´í…Œê³ ë¦¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");
        const title = document.getElementById('postTitle').value.trim(); const content = document.getElementById('postContent').value.trim();
        if(!title || !content) return alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        await fetch(`${API_BASE}/api/community/posts?categoryId=${currentCategoryId}&title=${encodeURIComponent(title)}&content=${encodeURIComponent(content)}&authorNickname=${encodeURIComponent(myNickname)}`, {method:'POST'});
        document.getElementById('postTitle').value = ''; document.getElementById('postContent').value = ''; toggleWriteForm(); loadPosts(currentCategoryId);
    }
    async function deletePost(postId, event) {
        event.stopPropagation();
        if(confirm("ì •ë§ ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            const res = await fetch(`${API_BASE}/api/community/posts/${postId}?nickname=${encodeURIComponent(myNickname)}&role=${encodeURIComponent(myRole)}`, {method:'DELETE'});
            if(res.ok) { const text = await res.text(); if(text === 'forbidden') alert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤!"); else loadPosts(currentCategoryId); }
        }
    }

    // ==========================================
    // ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„: ì–´ë“œë¯¼ ë§¤ì¹˜ ì ìˆ˜íŒ ì…ë ¥ì¹¸ í™•ëŒ€
    // ==========================================
    async function loadMatches() {
        if (document.activeElement && document.activeElement.closest('#matchList')) return;
        try {
            const res = await fetch(`${API_BASE}/matches?_t=${Date.now()}`); const matches = await res.json();
            const listDiv = document.getElementById('matchList'); listDiv.innerHTML = '<h4 style="margin:15px 0 10px 0;">ğŸ ê²½ê¸° ê²°ê³¼ ìˆ˜ì •</h4>';
            matches.forEach(m => {
                const div = document.createElement('div');
                div.style.cssText = "padding:15px; background:rgba(0,0,0,0.2); margin-bottom:10px; border-radius:10px; border:1px solid var(--border-color); display:flex; align-items:center; gap:10px; font-size:14px;";
                div.innerHTML = `
                    <span class="badge ${m.status === 'FINISHED' ? 'status-finished' : 'status-scheduled'}">${m.status === 'FINISHED' ? 'ì¢…ë£Œ' : 'ì˜ˆì •'}</span>
                    <b style="flex:1">${m.homeTeamName} vs ${m.awayTeamName}</b>

                    <input type="number" id="h-${m.id}" value="${m.homeScore}" style="width:65px; height:40px; font-size:18px; font-weight:bold; text-align:center; border-radius:8px;">
                    <span style="font-weight:bold; font-size:18px;">:</span>
                    <input type="number" id="a-${m.id}" value="${m.awayScore}" style="width:65px; height:40px; font-size:18px; font-weight:bold; text-align:center; border-radius:8px;">

                    <button class="btn-main" onclick="updateResult('${m.id}')" style="width:auto; padding:10px 15px; font-size:14px; margin-left:5px;">ë°˜ì˜</button>
                `;
                listDiv.appendChild(div);
            });
        } catch(e) {}
    }

    async function searchVolta() {
        const nickname = document.getElementById('voltaSearchInput').value.trim(); if(!nickname) return alert("ê²€ìƒ‰í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        const container = document.getElementById('voltaResultContainer'); container.innerHTML = '<div style="text-align:center; padding: 60px 0;"><div style="width:40px; height:40px; border:4px solid var(--primary); border-top:4px solid transparent; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 15px;"></div><p style="color:var(--text-muted);">ë„¥ìŠ¨ ì„œë²„ í†µì‹  ì¤‘... (ìµœëŒ€ 20ê²½ê¸°)</p></div><style>@keyframes spin{100%{transform:rotate(360deg);}}</style>';
        try {
            const res = await fetch(`${API_BASE}/api/volta/recent?nickname=${encodeURIComponent(nickname)}`);
            if (!res.ok) { container.innerHTML = `<p style="color:var(--lose-color); text-align:center; padding:40px;">âŒ ê²½ê¸° ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`; return; }
            const matchDataArray = await res.json();
            if(!matchDataArray || matchDataArray.length === 0) { container.innerHTML = `<p style="color:var(--lose-color); text-align:center; padding:40px;">âŒ ìŠ¤íƒ¯ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>`; return; }
            let htmlStr = "";
            matchDataArray.forEach((data, index) => {
                const matchInfo = data.matchInfo; if(!matchInfo || matchInfo.length === 0) return;
                let teamWin = matchInfo.filter(p => p.matchDetail && p.matchDetail.matchResult === 'ìŠ¹'); let teamLoss = matchInfo.filter(p => p.matchDetail && p.matchDetail.matchResult !== 'ìŠ¹');
                let teamA, teamB, typeA, typeB;
                if (teamWin.length > 0) { teamA = teamWin; teamB = teamLoss; typeA = 'win'; typeB = 'lose'; } else { teamA = matchInfo.slice(0, 4); teamB = matchInfo.slice(4, 8); typeA = 'draw'; typeB = 'draw'; }
                const renderRows = (players) => {
                    return players.map(info => {
                        const s = (info.player && info.player.length > 0) ? info.player[0].status : {}; const isMe = info.nickname.toLowerCase() === nickname.toLowerCase();
                        return `<div class="player-row ${isMe ? 'is-me' : ''}"><div class="p-name">${info.nickname}</div><div class="p-rating">â­${(s.spRating||0).toFixed(1)}</div><div class="p-stats"><span title="ê³¨">âš½${s.goal||0}</span><span title="ì–´ì‹œ">ğŸ‘Ÿ${s.assist||0}</span><span title="íƒœí´">ğŸ›¡ï¸${s.tackle||0}</span></div></div>`;
                    }).join('');
                };
                htmlStr += `<div class="match-card"><div class="match-header">ğŸ MATCH ${index + 1}</div><div class="match-teams"><div class="team-box ${typeA}"><div class="team-title">${typeA.toUpperCase()}</div>${renderRows(teamA)}</div><div class="team-box ${typeB}" style="border-left: 1px solid var(--border-color);"><div class="team-title">${typeB.toUpperCase()}</div>${renderRows(teamB)}</div></div></div>`;
            });
            container.innerHTML = htmlStr;
        } catch (e) { container.innerHTML = `<p style="color:var(--lose-color); text-align:center; padding:40px;">âŒ í†µì‹  ì—ëŸ¬ ë°œìƒ!</p>`; }
    }

    function connectChat(nickname, role) {
        myNickname = nickname; myRole = role || "GUEST"; myColor = (myRole === 'ADMIN' || myNickname === 'ìš´ì˜ì§„') ? '#ef4444' : getUniqueColor(myNickname);
        socket = new WebSocket(`${IS_LOCAL ? 'ws' : 'wss'}://${SERVER_URL}/ws/chat?nickname=${encodeURIComponent(myNickname)}&role=${encodeURIComponent(myRole)}`);
        socket.onmessage = (e) => {
            const data = e.data; const win = document.getElementById('chat-window');
            if (data.startsWith("[USER_LIST]")) { document.getElementById('userDisplay').innerText = data.replace("[USER_LIST]", "ì ‘ì†ì¤‘: "); return; }
            if (data === "[CLEAR_CHAT]") { win.innerHTML = ""; return; }
            if (data.startsWith("[NOTICE]")) { document.getElementById('notice-text').innerText = data.replace("[NOTICE]", ""); document.getElementById('notice-bar').style.display = 'block'; return; }
            const div = document.createElement('div'); div.className = 'chat-msg'; div.innerHTML = data; win.appendChild(div); win.scrollTop = win.scrollHeight;
        };
    }
    function sendMsg() { const input = document.getElementById('chatInput'); const val = input.value.trim(); if (!val || !socket) return; if (val.startsWith("/") && (myNickname === "ìš´ì˜ì§„" || myRole === "ADMIN")) socket.send(val); else socket.send(`<strong style="color:${myColor}">${myNickname}</strong>: ${val}`); input.value = ''; }

    async function loadLeaderboard() {
        try {
            const res = await fetch(`${API_BASE}/teams?_t=${Date.now()}`); const teams = await res.json();
            document.getElementById('leaderboardBody').innerHTML = teams.map((t, i) => `<tr><td style="color:${i===0?'var(--gold)':(i===1?'#cbd5e1':(i===2?'#d97706':''))}; font-weight:800; font-size:1.1rem;">${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1}</td><td style="font-weight:bold">${t.teamName}</td><td>${t.wins}</td><td>${t.draws}</td><td>${t.losses}</td><td class="pts-column">${t.totalPoints}</td></tr>`).join('');
        } catch(e) {}
    }
    async function createTeam() { const n = document.getElementById('newTeamName').value.trim(); if (!n) return; await fetch(`${API_BASE}/create-team?name=${encodeURIComponent(n)}`); loadLeaderboard(); document.getElementById('newTeamName').value = ''; }
    async function updateResult(id) { const h = document.getElementById(`h-${id}`).value; const a = document.getElementById(`a-${id}`).value; await fetch(`${API_BASE}/update-result?matchId=${id}&homeScore=${h}&awayScore=${a}`); loadLeaderboard(); setTimeout(() => alert("ë°˜ì˜ ì™„ë£Œ"), 50); }

    async function checkAuth() {
        try {
            const res = await fetch(`${API_BASE}/api/me`);
            if (res.ok) {
                const user = JSON.parse(await res.text());
                if (user && user.nickname) {
                    document.getElementById('login-section').style.display = 'none'; document.getElementById('top-nav').style.display = 'flex'; document.getElementById('main-content').style.display = 'block';
                    if (user.role === 'ADMIN') document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                    else document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                    connectChat(user.nickname, user.role); loadLeaderboard(); document.getElementById('voltaSearchInput').value = user.nickname;
                }
            }
        } catch (e) {}
    }

    async function guestLogin() { const n = document.getElementById('nickInput').value; if(!n) return; await fetch(`${API_BASE}/api/login/guest?nickname=${encodeURIComponent(n)}`, { method: 'POST' }); checkAuth(); }
    async function adminLogin() { const id = document.getElementById('adminId').value; const pw = document.getElementById('adminPw').value; const res = await fetch(`${API_BASE}/api/login/admin?loginId=${id}&password=${pw}`, { method: 'POST' }); if (res.ok) checkAuth(); else alert("ì •ë³´ ë¶ˆì¼ì¹˜"); }
    function logout() { fetch(`${API_BASE}/api/logout`, {method:'POST'}).then(()=>location.reload()); }
    async function resetAll() { if (confirm("ë°ì´í„°ë¥¼ ì™„ì „ ì´ˆê¸°í™”í• ê¹Œìš”?")) { await fetch(`${API_BASE}/reset-all`); location.reload(); } }
    async function genSchedule() { const res = await fetch(`${API_BASE}/generate-schedule`); alert(await res.text()); loadMatches(); }

    setInterval(() => { if (document.getElementById('main-content').style.display === 'block') { loadLeaderboard(); const adminTab = document.getElementById('admin-tab'); if (adminTab && adminTab.style.display === 'block') loadMatches(); } }, 5000);
    window.onload = checkAuth; document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMsg(); });
</script>
</body>
</html>