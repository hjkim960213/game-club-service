<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì–´ì„œì™€ | ë‚´ì „ í†µí•© í¬í„¸</title>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        /* ğŸš© í…Œë§ˆë³„ ìƒ‰ìƒ ë³€ìˆ˜ ì„¤ì • */
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #1a1a1b;
            --border-color: #eee;
            --input-bg: #ffffff;
            --header-bg: #1a1a1b;
        }

        [data-theme='dark'] {
            --bg-color: #212121;
            --card-bg: #2f2f2f;
            --text-color: #ececec;
            --border-color: #444;
            --input-bg: #3d3d3d;
            --header-bg: #000000;
        }

        body { font-family: 'Pretendard', sans-serif; padding: 30px; background-color: var(--bg-color); color: var(--text-color); margin: 0; transition: 0.3s; }
        .container { max-width: 1300px; margin: 0 auto; background: var(--card-bg); padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: 0.3s; position: relative; }

        .sidebar { position: fixed; right: 25px; top: 120px; display: flex; flex-direction: column; gap: 15px; z-index: 100; }
        .link-btn { padding: 14px; border-radius: 12px; text-decoration: none; color: white; text-align: center; font-weight: 800; font-size: 13px; transition: 0.3s; width: 80px; }
        .youtube { background: linear-gradient(45deg, #ff0000, #cc0000); }
        .discord { background: linear-gradient(45deg, #5865F2, #4752c4); }
        .kakao { background: linear-gradient(45deg, #fee500, #fada0a); color: #3c1e1e !important; }

        .dashboard-grid { display: grid; grid-template-columns: 6.5fr 3.5fr; gap: 40px; margin-top: 20px; align-items: start; }
        @media (max-width: 1000px) { .dashboard-grid { grid-template-columns: 1fr; } }

        .header-section { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid var(--border-color); padding-bottom: 20px; margin-bottom: 20px; }

        /* ğŸš© í…Œë§ˆ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë° ìœ„ì¹˜ */
        .theme-toggle { background: #666; color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; cursor: pointer; border: none; transition: 0.2s; }
        .theme-toggle:hover { background: #444; }
        .login-theme-box { position: absolute; top: 20px; right: 20px; }

        .leaderboard-card { background: var(--card-bg); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; text-align: center; }
        th { background-color: var(--header-bg); color: #fff; padding: 18px; }
        td { padding: 20px; border-bottom: 1px solid var(--border-color); color: var(--text-color); }
        .rank-1 { color: #ffbb00 !important; font-weight: 900; }
        .pts-column { font-size: 20px; font-weight: 900; color: #007bff; }

        .badge { padding: 6px 12px; border-radius: 30px; font-size: 12px; font-weight: bold; color: white; display: inline-block; min-width: 70px; }
        .status-finished { background: #10b981; }
        .status-scheduled { background: #94a3b8; }

        .admin-only { display: none; margin-top: 40px; padding: 30px; background: rgba(239, 68, 68, 0.1); border: 2px dashed #ff4d4f; border-radius: 20px; }
        button { padding: 10px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-main { background: #007bff; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        input { padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 10px; background: var(--input-bg); color: var(--text-color); }

        .chat-container { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 15px; padding: 20px; height: 100%; display: flex; flex-direction: column; }
        #chat-window { flex: 1; min-height: 500px; max-height: 600px; overflow-y: scroll; margin-bottom: 15px; padding-right: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <a href="https://www.youtube.com/@welcomevolta" target="_blank" class="link-btn youtube">ìœ íŠœë¸Œ</a>
    <a href="https://discord.gg/cPeJNTEgWU" target="_blank" class="link-btn discord">ë””ìŠ¤ì½”ë“œ</a>
    <a href="https://open.kakao.com/o/gO6ji4ye" target="_blank" class="link-btn kakao">ì¹´í†¡</a>
</div>

<div class="container">
    <div id="login-section">
        <div class="login-theme-box">
            <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ— í…Œë§ˆ ë³€ê²½</button>
        </div>
        <h1 style="text-align:center;">ğŸ® ì–´ì„œì™€ ë³¼íƒ€í´ëŸ½ ë‚´ì „ í¬íƒˆ</h1>
        <div style="text-align:center; margin-top:50px;">
            <input type="text" id="nickInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥"><br>
            <button class="btn-main" onclick="guestLogin()">ê²ŒìŠ¤íŠ¸ ì…ì¥</button>
            <hr style="margin:30px 0; border:0; border-top:1px solid var(--border-color);">
            <input type="text" id="adminId" placeholder="ì•„ì´ë””"><br>
            <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸"><br>
            <button style="background:#333; color:white;" onclick="adminLogin()">ìš´ì˜ì§„ ë¡œê·¸ì¸</button>
        </div>
    </div>

    <div id="main-content" style="display:none;">
        <div class="header-section">
            <div>
                <h1>ğŸ† ì–´ì„œì™€ ë‚´ì „ ìˆœìœ„í‘œ
                    <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ— í…Œë§ˆ ë³€ê²½</button>
                </h1>
                <p id="userDisplay" style="font-weight:bold; color:#007bff; margin-top:10px;"></p>
            </div>
            <button class="btn-danger" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div class="dashboard-grid">
            <div class="left-section">
                <div class="leaderboard-card">
                    <table>
                        <thead>
                        <tr><th>ìˆœìœ„</th><th>íŒ€ ì´ë¦„</th><th>ìŠ¹</th><th>ë¬´</th><th>íŒ¨</th><th>ìŠ¹ì </th></tr>
                        </thead>
                        <tbody id="leaderboardBody"></tbody>
                    </table>
                </div>
                <div id="admin-tab" class="admin-only">
                    <h2 style="color:#ef4444; margin-top:0;">ğŸ› ï¸ ìš´ì˜ì§„ ê´€ë¦¬ ë„êµ¬</h2>
                    <div style="background: var(--card-bg); padding: 25px; border-radius: 15px; margin-bottom: 20px; border: 1px solid var(--border-color);">
                        <h4 style="margin-top:0">ğŸš© ì‹ ê·œ íŒ€ ìƒì„±</h4>
                        <div style="display: flex; gap:10px">
                            <input type="text" id="newTeamName" placeholder="ìƒˆ íŒ€ ì´ë¦„" style="flex:1; margin:0">
                            <button class="btn-main" onclick="createTeam()" style="width: 120px;">íŒ€ ë§Œë“¤ê¸°</button>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <button class="btn-main" onclick="genSchedule()">ğŸ“… ëŒ€ì§„í‘œ ìƒì„±</button>
                        <button class="btn-danger" onclick="resetAll()">âš ï¸ ë°ì´í„° ì™„ì „ ì´ˆê¸°í™”</button>
                    </div>
                    <div id="matchList"></div>
                </div>
            </div>

            <div class="right-section">
                <div class="chat-container">
                    <h3 style="margin-top:0;">ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ… <span style="font-size:12px; color:#ff4d4f;">â— LIVE</span></h3>
                    <div id="chat-window"></div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="chatInput" style="flex:1; margin:0" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
                        <button class="btn-main" onclick="sendMsg()">ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let socket;
    let myNickname = "";
    let myColor = "";

    // ğŸš© [ìˆ˜ì •] LocalStorageì—ì„œ í…Œë§ˆë¥¼ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ ê¸°ë³¸ê°’ 'light' ì„¤ì •
    let currentTheme = localStorage.getItem('theme') || 'light';

    // ì´ˆê¸° í…Œë§ˆ ì ìš©
    document.documentElement.setAttribute('data-theme', currentTheme);

    function toggleTheme() {
        currentTheme = (currentTheme === 'light') ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);

        // ğŸš© [ì¶”ê°€] ì„ íƒí•œ í…Œë§ˆë¥¼ ë¸Œë¼ìš°ì €ì— ì €ì¥
        localStorage.setItem('theme', currentTheme);

        if(myNickname) myColor = (myNickname === 'ìš´ì˜ì§„') ? '#ff4d4f' : getUniqueColor(myNickname);
    }

    function getUniqueColor(nickname) {
        let sum = 0;
        for (let i = 0; i < nickname.length; i++) sum += nickname.charCodeAt(i);
        const hue = (sum * 137.5) % 360;
        // ë‹¤í¬ëª¨ë“œì¼ ë•Œ ê°€ì‹œì„±ì„ ìœ„í•´ ëª…ë„ë¥¼ ë” ë°ê²Œ ì¡°ì •
        const lightness = (currentTheme === 'dark') ? '65%' : '45%';
        return `hsl(${hue}, 80%, ${lightness})`;
    }

    // --- ì´í•˜ ë¡œì§ ë™ì¼ ---
    async function loadLeaderboard() {
        try {
            const res = await fetch('/teams?_t=' + new Date().getTime());
            const teams = await res.json();
            const body = document.getElementById('leaderboardBody');
            body.innerHTML = teams.map((t, i) => `
                <tr class="${i < 3 ? 'rank-' + (i + 1) : ''}">
                    <td>${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : i + 1}</td>
                    <td style="font-weight:bold">${t.teamName}</td>
                    <td>${t.wins}</td><td>${t.draws}</td><td>${t.losses}</td>
                    <td class="pts-column">${t.totalPoints}</td>
                </tr>
            `).join('');
        } catch(e) { console.error("ìˆœìœ„í‘œ ê°±ì‹  ì—ëŸ¬", e); }
    }

    async function loadMatches() {
        const res = await fetch('/matches?_t=' + new Date().getTime());
        const matches = await res.json();
        const listDiv = document.getElementById('matchList');
        listDiv.innerHTML = '<h3>ğŸ ê²½ê¸° ê²°ê³¼ ìˆ˜ì •</h3>';
        matches.forEach(m => {
            const div = document.createElement('div');
            div.style.cssText = "padding:15px; background:var(--input-bg); margin-bottom:10px; border-radius:10px; border:1px solid var(--border-color); display:flex; align-items:center; gap:10px;";
            div.innerHTML = `
                <span class="badge ${m.status === 'FINISHED' ? 'status-finished' : 'status-scheduled'}">${m.status === 'FINISHED' ? 'ì¢…ë£Œ' : 'ì˜ˆì •'}</span>
                <b style="flex:1">${m.homeTeamName} vs ${m.awayTeamName}</b>
                <input type="number" id="h-${m.id}" value="${m.homeScore}" style="width:50px; margin:0; text-align:center;"> :
                <input type="number" id="a-${m.id}" value="${m.awayScore}" style="width:50px; margin:0; text-align:center;">
                <button onclick="updateResult('${m.id}')" style="background:#ffbb00; padding:8px 15px; color:#000;">ë°˜ì˜</button>
            `;
            listDiv.appendChild(div);
        });
    }

    async function createTeam() {
        const nameInput = document.getElementById('newTeamName');
        const name = nameInput.value.trim();
        if (!name) return alert("íŒ€ ì´ë¦„ ì…ë ¥!");
        await fetch(`/create-team?name=${encodeURIComponent(name)}`);
        loadLeaderboard();
        nameInput.value = '';
    }

    function connectChat(nickname, role) {
        myNickname = nickname;
        myColor = (role === 'ADMIN') ? '#ff4d4f' : getUniqueColor(nickname);
        socket = new WebSocket(`ws://${location.host}/ws/chat?nickname=${encodeURIComponent(nickname)}`);
        socket.onmessage = (e) => {
            if (e.data.startsWith("[USER_LIST]")) {
                document.getElementById('userDisplay').innerText = e.data.replace("[USER_LIST]", "ğŸŸ¢ ì‹¤ì‹œê°„ ");
                return;
            }
            const win = document.getElementById('chat-window');
            const div = document.createElement('div');
            div.style.marginBottom = "10px";
            div.innerHTML = e.data;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        };
    }

    function sendMsg() {
        const input = document.getElementById('chatInput');
        if (!input.value || !socket) return;
        const msg = `<strong style="color:${myColor}">${myNickname}</strong>: ${input.value}`;
        socket.send(msg);
        input.value = '';
    }

    async function updateResult(id) {
        await fetch(`/update-result?matchId=${id}&homeScore=${document.getElementById(`h-${id}`).value}&awayScore=${document.getElementById(`a-${id}`).value}`);
        loadLeaderboard();
        setTimeout(() => alert("ê²°ê³¼ ë°˜ì˜ ì™„ë£Œ!"), 50);
    }

    async function resetAll() {
        if (!confirm("âš ï¸ ëª¨ë“  ë°ì´í„° ì‚­ì œ?")) return;
        await fetch('/reset-all');
        location.reload();
    }

    async function genSchedule() {
        const res = await fetch('/generate-schedule');
        alert(await res.text());
        loadMatches();
    }

    async function checkAuth() {
        const res = await fetch('/api/me');
        if (res.ok) {
            const user = await res.json();
            if (user && user.nickname) {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                if (user.role === 'ADMIN') document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                connectChat(user.nickname, user.role);
                loadLeaderboard(); loadMatches();
            }
        }
    }

    async function guestLogin() {
        const n = document.getElementById('nickInput').value;
        await fetch(`/api/login/guest?nickname=${encodeURIComponent(n)}`, { method: 'POST' });
        checkAuth();
    }

    async function adminLogin() {
        const id = document.getElementById('adminId').value;
        const pw = document.getElementById('adminPw').value;
        const res = await fetch(`/api/login/admin?loginId=${id}&password=${pw}`, { method: 'POST' });
        if (res.ok) checkAuth(); else alert("ì•„ì´ë””/ë¹„ë²ˆ í‹€ë¦¼");
    }

    async function logout() {
        await fetch('/api/logout', { method: 'POST' });
        location.href = "/";
    }

    setInterval(() => { if (document.getElementById('main-content').style.display === 'block') loadLeaderboard(); }, 5000);
    window.onload = checkAuth;
    document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMsg(); });
</script>
</body>
</html>