<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì–´ì„œì™€ | ë‚´ì „ í†µí•© í¬í„¸</title>
    <style>
        /* (ê¸°ì¡´ CSS ìŠ¤íƒ€ì¼ ìœ ì§€: ëª¨ë°”ì¼ ë°˜ì‘í˜• ë””ìì¸) */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root { --bg-color: #f0f2f5; --card-bg: #ffffff; --text-color: #1a1a1b; --border-color: #eee; --input-bg: #ffffff; --header-bg: #1a1a1b; }
        [data-theme='dark'] { --bg-color: #1a1a1b; --card-bg: #2d2d2d; --text-color: #ececec; --border-color: #444; --input-bg: #3d3d3d; --header-bg: #000000; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; transition: 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; background: var(--card-bg); min-height: 100vh; padding: 20px; box-sizing: border-box; }
        #notice-bar { display: none; background: #ff4d4f; color: white; padding: 12px; border-radius: 12px; margin-bottom: 20px; font-weight: bold; text-align: center; }
        .dashboard-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 20px; }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }
        .chat-container { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 15px; padding: 15px; display: flex; flex-direction: column; height: 500px; }
        #chat-window { flex: 1; overflow-y: auto; margin-bottom: 10px; font-size: 14px; }
        .btn-main { background: #007bff; color: white; border-radius: 10px; border: none; font-weight: bold; padding: 10px; cursor: pointer; }
    </style>
</head>
<body>
<div class="container">
    <div id="notice-bar">ğŸ“¢ <span id="notice-text"></span></div>

    <div id="login-section" style="text-align:center; padding-top:60px;">
        <h1>ğŸ® ë³¼íƒ€í´ëŸ½ í¬í„¸</h1>
        <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
            <input type="text" id="nickInput" placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„" style="width:80%; max-width:300px;">
            <button class="btn-main" onclick="guestLogin()" style="width:80%; max-width:300px;">ê²ŒìŠ¤íŠ¸ ì…ì¥</button>
            <hr style="width:80%; max-width:300px; margin:20px 0; border:0; border-top:1px solid var(--border-color);">
            <input type="text" id="adminId" placeholder="ê´€ë¦¬ì ID" style="width:80%; max-width:300px;">
            <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸" style="width:80%; max-width:300px;">
            <button onclick="adminLogin()" style="background:#333; color:white; width:80%; max-width:300px; padding:10px; border-radius:10px;">ìš´ì˜ì§„ ë¡œê·¸ì¸</button>
        </div>
    </div>

    <div id="main-content" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h1>ğŸ† ìˆœìœ„í‘œ</h1>
            <button onclick="logout()" style="background:#ef4444; color:white; border-radius:10px; border:none; padding:8px 15px; cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <p id="userDisplay" style="color:#007bff; font-weight:bold; margin-bottom:15px;"></p>

        <div class="dashboard-grid">
            <div id="leaderboardBody" style="border:1px solid #eee; border-radius:15px; padding:15px;">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            <div class="chat-container">
                <div id="chat-window"></div>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="chatInput" style="flex:1;" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
                    <button class="btn-main" onclick="sendMsg()">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let socket;
    let myNickname = "";
    const SERVER_URL = "game-club-service.onrender.com";

    // ğŸš© ì„œë²„ í†µì‹  ì—°ê²°
    function connectChat(nickname) {
        myNickname = nickname;
        socket = new WebSocket(`wss://${SERVER_URL}/ws/chat`);

        socket.onmessage = (e) => {
            const data = e.data;
            const win = document.getElementById('chat-window');

            if (data.startsWith("[USER_LIST]")) {
                document.getElementById('userDisplay').innerText = data.replace("[USER_LIST]", "ğŸŸ¢ ");
                return;
            }
            if (data === "[CLEAR_CHAT]") {
                win.innerHTML = "<p style='color:gray; text-align:center;'>ì±„íŒ…ì°½ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</p>";
                return;
            }
            if (data.startsWith("[CLEAR_COUNT]")) {
                const count = parseInt(data.replace("[CLEAR_COUNT]", ""));
                const msgs = win.getElementsByTagName('div');
                for (let i = 0; i < count; i++) if (msgs.length > 0) win.removeChild(msgs[msgs.length - 1]);
                return;
            }
            if (data.startsWith("[NOTICE]")) {
                const bar = document.getElementById('notice-bar');
                document.getElementById('notice-text').innerText = data.replace("[NOTICE]", "");
                bar.style.display = 'block';
                return;
            }

            const div = document.createElement('div');
            div.style.marginBottom = "8px";
            div.innerHTML = data;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        };
    }

    // ğŸš© ëª…ë ¹ì–´ ì „ì†¡ í•„í„°ë§
    function sendMsg() {
        const input = document.getElementById('chatInput');
        const val = input.value.trim();
        if (!val || !socket) return;

        // ëª…ë ¹ì–´ëŠ” ë‚ ê²ƒ ê·¸ëŒ€ë¡œ ë³´ë‚´ê³ , ì¼ë°˜ ì±„íŒ…ì€ íƒœê·¸ë¥¼ ì”Œì›Œ ë³´ëƒ„
        if (val.startsWith("/")) {
            socket.send(val);
        } else {
            const color = (myNickname === "ìš´ì˜ì§„") ? "#ff4d4f" : "#007bff";
            socket.send(`<strong style="color:${color}">${myNickname}</strong>: ${val}`);
        }
        input.value = '';
    }

    // ğŸš© JSON ì˜¤ë¥˜ ë°©ì§€ ë¡œì§ì´ ì¶”ê°€ëœ ì¸ì¦ í™•ì¸
    async function checkAuth() {
        try {
            const res = await fetch(`https://${SERVER_URL}/api/me`);
            if (res.ok) {
                const text = await res.text();
                if (!text) return; // ë‚´ìš© ì—†ìœ¼ë©´ ì¢…ë£Œ
                const user = JSON.parse(text);
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                connectChat(user.nickname);
            }
        } catch (e) { console.log("ì„¸ì…˜ ë§Œë£Œ ë˜ëŠ” ì—†ìŒ"); }
    }

    async function guestLogin() {
        const n = document.getElementById('nickInput').value;
        await fetch(`https://${SERVER_URL}/api/login/guest?nickname=${encodeURIComponent(n)}`, { method: 'POST' });
        checkAuth();
    }

    async function adminLogin() {
        const id = document.getElementById('adminId').value;
        const pw = document.getElementById('adminPw').value;
        await fetch(`https://${SERVER_URL}/api/login/admin?loginId=${id}&password=${pw}`, { method: 'POST' });
        checkAuth();
    }

    function logout() { fetch(`https://${SERVER_URL}/api/logout`, {method:'POST'}).then(()=>location.reload()); }
    window.onload = checkAuth;
    document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMsg(); });

    // ì„œë²„ ê¹¨ìš°ê¸° (10ë¶„ë§ˆë‹¤)
    setInterval(() => fetch(`https://${SERVER_URL}/api/me`).catch(() => {}), 600000);
</script>
</body>
</html>