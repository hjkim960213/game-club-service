<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì–´ì„œì™€ | ë‚´ì „ í†µí•© í¬í„¸</title>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #1a1a1b;
            --border-color: #eee;
            --input-bg: #ffffff;
            --header-bg: #1a1a1b;
        }

        [data-theme='dark'] {
            --bg-color: #1a1a1b;
            --card-bg: #2d2d2d;
            --text-color: #ececec;
            --border-color: #444;
            --input-bg: #3d3d3d;
            --header-bg: #000000;
        }

        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; transition: 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; background: var(--card-bg); min-height: 100vh; padding: 20px; box-sizing: border-box; position: relative; }

        /* ğŸ“¢ ê³µì§€ì‚¬í•­ ë°” ìŠ¤íƒ€ì¼ */
        #notice-bar {
            display: none; background: #ff4d4f; color: white; padding: 12px;
            border-radius: 12px; margin-bottom: 20px; font-weight: bold; text-align: center;
            box-shadow: 0 4px 10px rgba(255, 77, 79, 0.3);
        }

        /* ë°˜ì‘í˜• ëŒ€ì‹œë³´ë“œ ê·¸ë¦¬ë“œ */
        .dashboard-grid { display: grid; grid-template-columns: 6.5fr 3.5fr; gap: 30px; margin-top: 20px; align-items: start; }

        @media (max-width: 1000px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .sidebar { position: static !important; flex-direction: row !important; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
            .link-btn { width: auto !important; flex: 1; min-width: 70px; }
            .container { padding: 15px; }
            .header-section h1 { font-size: 1.3rem; }
        }

        .header-section { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }

        .sidebar { position: fixed; right: 20px; top: 120px; display: flex; flex-direction: column; gap: 12px; z-index: 100; }
        .link-btn { padding: 12px; border-radius: 10px; text-decoration: none; color: white; text-align: center; font-weight: 800; font-size: 12px; width: 65px; transition: 0.2s; }
        .youtube { background: #ff0000; } .discord { background: #5865F2; } .kakao { background: #fee500; color: #3c1e1e !important; }

        .leaderboard-card { background: var(--card-bg); border-radius: 16px; overflow-x: auto; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; text-align: center; min-width: 500px; }
        th { background-color: var(--header-bg); color: #fff; padding: 15px; font-size: 14px; }
        td { padding: 15px; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        .rank-1 { color: #ffbb00 !important; font-weight: 900; }
        .pts-column { font-size: 18px; font-weight: 900; color: #007bff; }

        .chat-container { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 15px; padding: 15px; display: flex; flex-direction: column; height: 550px; box-sizing: border-box; }
        #chat-window { flex: 1; overflow-y: auto; margin-bottom: 12px; padding-right: 5px; font-size: 14px; }

        button { padding: 10px 18px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; }
        input { padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--input-bg); color: var(--text-color); outline: none; }
        .btn-main { background: #007bff; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .theme-toggle { background: #666; color: white; border-radius: 20px; font-size: 11px; }

        .admin-only { display: none; margin-top: 30px; padding: 20px; background: rgba(239, 68, 68, 0.05); border: 2px dashed #ff4d4f; border-radius: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div id="notice-bar">ğŸ“¢ <span id="notice-text"></span></div>

    <div class="sidebar">
        <a href="https://www.youtube.com/@welcomevolta" target="_blank" class="link-btn youtube">ìœ íŠœë¸Œ</a>
        <a href="https://discord.gg/cPeJNTEgWU" target="_blank" class="link-btn discord">ë””ìŠ¤ì½”ë“œ</a>
        <a href="https://open.kakao.com/o/gO6ji4ye" target="_blank" class="link-btn kakao">ì¹´í†¡</a>
    </div>

    <div id="login-section" style="text-align:center; padding-top:60px;">
        <h1>ğŸ® ë³¼íƒ€í´ëŸ½ ë‚´ì „ í¬íƒˆ</h1>
        <button class="theme-toggle" onclick="toggleTheme()" style="margin-bottom:30px">ğŸŒ— í…Œë§ˆ ë³€ê²½</button>
        <div style="display:flex; flex-direction:column; align-items:center; gap:12px;">
            <input type="text" id="nickInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" style="width:80%; max-width:300px;">
            <button class="btn-main" onclick="guestLogin()" style="width:80%; max-width:300px;">ê²ŒìŠ¤íŠ¸ ì…ì¥</button>
            <hr style="width:80%; max-width:300px; margin:20px 0; border:0; border-top:1px solid var(--border-color);">
            <input type="text" id="adminId" placeholder="ê´€ë¦¬ì ID" style="width:80%; max-width:300px;">
            <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸" style="width:80%; max-width:300px;">
            <button style="background:#333; color:white; width:80%; max-width:320px;" onclick="adminLogin()">ìš´ì˜ì§„ ë¡œê·¸ì¸</button>
        </div>
    </div>

    <div id="main-content" style="display:none;">
        <div class="header-section">
            <h1>ğŸ† ìˆœìœ„í‘œ <button class="theme-toggle" onclick="toggleTheme()" style="padding:5px 10px">ğŸŒ—</button></h1>
            <button class="btn-danger" onclick="logout()" style="padding:8px 15px; font-size:12px">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <p id="userDisplay" style="font-weight:bold; color:#007bff; font-size:13px; margin-bottom:15px;"></p>

        <div class="dashboard-grid">
            <div class="left-section">
                <div class="leaderboard-card">
                    <table>
                        <thead>
                        <tr><th>ìˆœìœ„</th><th>íŒ€ ì´ë¦„</th><th>ìŠ¹</th><th>ë¬´</th><th>íŒ¨</th><th>ìŠ¹ì </th></tr>
                        </thead>
                        <tbody id="leaderboardBody"></tbody>
                    </table>
                </div>

                <div id="admin-tab" class="admin-only">
                    <h2 style="color:#ef4444; margin:0 0 15px 0;">ğŸ› ï¸ ìš´ì˜ì§„ ì „ìš© ë„êµ¬</h2>
                    <div style="background: var(--card-bg); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid var(--border-color);">
                        <h4 style="margin-top:0">ğŸš© ì‹ ê·œ íŒ€ ë“±ë¡</h4>
                        <div style="display: flex; gap:10px">
                            <input type="text" id="newTeamName" placeholder="íŒ€ ì´ë¦„" style="flex:1; margin:0">
                            <button class="btn-main" onclick="createTeam()">ìƒì„±</button>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <button class="btn-main" onclick="genSchedule()" style="flex:1">ğŸ“… ëŒ€ì§„í‘œ ìƒì„±</button>
                        <button class="btn-danger" onclick="resetAll()" style="flex:1">âš ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
                    </div>
                    <div id="matchList"></div>
                </div>
            </div>

            <div class="right-section">
                <div class="chat-container">
                    <h3 style="margin:0 0 10px 0; font-size:1.1rem;">ğŸ’¬ ì±„íŒ… <span style="font-size:11px; color:#ff4d4f;">â— LIVE</span></h3>
                    <div id="chat-window"></div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="chatInput" style="flex:1; margin:0" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
                        <button class="btn-main" onclick="sendMsg()">ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let socket;
    let myNickname = "";
    let myColor = "";
    let myRole = ""; // ğŸš© ì „ì—­ ë³€ìˆ˜ë¡œ ì—­í•  ì €ì¥
    const SERVER_URL = "game-club-service.onrender.com";

    let currentTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', currentTheme);

    function toggleTheme() {
        currentTheme = (currentTheme === 'light') ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        localStorage.setItem('theme', currentTheme);
        if(myNickname) myColor = (myRole === 'ADMIN' || myNickname === 'ìš´ì˜ì§„') ? '#ff4d4f' : getUniqueColor(myNickname);
    }

    function getUniqueColor(nickname) {
        let sum = 0;
        for (let i = 0; i < nickname.length; i++) sum += nickname.charCodeAt(i);
        const hue = (sum * 137.5) % 360;
        const lightness = (currentTheme === 'dark') ? '70%' : '45%';
        return `hsl(${hue}, 80%, ${lightness})`;
    }

    function connectChat(nickname, role) {
        myNickname = nickname;
        myRole = role; // ğŸš© ì—­í•  ì—…ë°ì´íŠ¸
        myColor = (role === 'ADMIN' || nickname === 'ìš´ì˜ì§„') ? '#ff4d4f' : getUniqueColor(nickname);

        // ğŸš© ì„œë²„ í•¸ë“¤ëŸ¬ì— role ì •ë³´ë„ ê°™ì´ ë³´ë‚´ì¤˜ì•¼ ë°±ì—”ë“œê°€ ADMINì„ì„ ì¦‰ì‹œ ì••ë‹ˆë‹¤.
        socket = new WebSocket(`wss://${SERVER_URL}/ws/chat?nickname=${encodeURIComponent(nickname)}&role=${encodeURIComponent(role)}`);

        socket.onmessage = (e) => {
            const data = e.data;
            const win = document.getElementById('chat-window');

            if (data.startsWith("[USER_LIST]")) {
                document.getElementById('userDisplay').innerText = data.replace("[USER_LIST]", "ğŸŸ¢ ì‹¤ì‹œê°„ ì ‘ì†: ");
                return;
            }
            if (data === "[CLEAR_CHAT]") {
                win.innerHTML = "<p style='color:gray; font-size:12px; text-align:center;'>ì±„íŒ…ì°½ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</p>";
                return;
            }
            if (data.startsWith("[CLEAR_COUNT]")) {
                const count = parseInt(data.replace("[CLEAR_COUNT]", ""));
                const messages = win.getElementsByTagName('div');
                for (let i = 0; i < count; i++) {
                    if (messages.length > 0) win.removeChild(messages[messages.length - 1]);
                }
                return;
            }
            if (data.startsWith("[NOTICE]")) {
                const bar = document.getElementById('notice-bar');
                document.getElementById('notice-text').innerText = data.replace("[NOTICE]", "");
                bar.style.display = 'block';
                return;
            }

            const div = document.createElement('div');
            div.style.marginBottom = "8px";
            div.innerHTML = data;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        };
        socket.onclose = () => console.log("ì„œë²„ ì—°ê²° ì¢…ë£Œ");
    }

    function sendMsg() {
        const input = document.getElementById('chatInput');
        const val = input.value.trim();
        if (!val || !socket) return;

        // ğŸš© ë‹‰ë„¤ì„ ë˜ëŠ” ì—­í• (Role)ë¡œ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
        const isAdmin = (myNickname === "ìš´ì˜ì§„" || myRole === "ADMIN");

        if (val.startsWith("/clear") && isAdmin) {
            socket.send(val);
        } else if (val.startsWith("/ê³µì§€ ") && isAdmin) {
            socket.send(val);
        } else {
            const msg = `<strong style="color:${myColor}">${myNickname}</strong>: ${val}`;
            socket.send(msg);
        }
        input.value = '';
    }

    async function loadLeaderboard() {
        try {
            const res = await fetch(`https://${SERVER_URL}/teams?_t=${Date.now()}`);
            const teams = await res.json();
            const body = document.getElementById('leaderboardBody');
            body.innerHTML = teams.map((t, i) => `
                <tr class="${i < 3 ? 'rank-' + (i + 1) : ''}">
                    <td>${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : i + 1}</td>
                    <td style="font-weight:bold">${t.teamName}</td>
                    <td>${t.wins}</td><td>${t.draws}</td><td>${t.losses}</td>
                    <td class="pts-column">${t.totalPoints}</td>
                </tr>
            `).join('');
        } catch(e) {}
    }

    async function loadMatches() {
        if (document.activeElement && document.activeElement.closest('#matchList')) return;

        try {
            const res = await fetch(`https://${SERVER_URL}/matches?_t=${Date.now()}`);
            const matches = await res.json();
            const listDiv = document.getElementById('matchList');
            listDiv.innerHTML = '<h4>ğŸ ê²½ê¸° ê²°ê³¼ ìˆ˜ì •</h4>';
            matches.forEach(m => {
                const div = document.createElement('div');
                div.style.cssText = "padding:12px; background:var(--input-bg); margin-bottom:10px; border-radius:10px; border:1px solid var(--border-color); display:flex; align-items:center; gap:8px; font-size:13px;";
                div.innerHTML = `
                    <span class="badge ${m.status === 'FINISHED' ? 'status-finished' : 'status-scheduled'}" style="font-size:11px;">${m.status === 'FINISHED' ? 'ì¢…ë£Œ' : 'ì˜ˆì •'}</span>
                    <b style="flex:1">${m.homeTeamName} vs ${m.awayTeamName}</b>
                    <input type="number" id="h-${m.id}" value="${m.homeScore}" style="width:40px; text-align:center; padding:5px;"> :
                    <input type="number" id="a-${m.id}" value="${m.awayScore}" style="width:40px; text-align:center; padding:5px;">
                    <button onclick="updateResult('${m.id}')" style="background:#ffbb00; padding:5px 10px; font-size:12px;">ë°˜ì˜</button>
                `;
                listDiv.appendChild(div);
            });
        } catch(e) {}
    }

    async function createTeam() {
        const nameInput = document.getElementById('newTeamName');
        const name = nameInput.value.trim();
        if (!name) return alert("íŒ€ ì´ë¦„ ì…ë ¥!");
        await fetch(`https://${SERVER_URL}/create-team?name=${encodeURIComponent(name)}`);
        loadLeaderboard();
        nameInput.value = '';
    }

    async function updateResult(id) {
        const h = document.getElementById(`h-${id}`).value;
        const a = document.getElementById(`a-${id}`).value;
        await fetch(`https://${SERVER_URL}/update-result?matchId=${id}&homeScore=${h}&awayScore=${a}`);
        loadLeaderboard();
        setTimeout(() => alert("ë°˜ì˜ ì™„ë£Œ"), 50);
    }

    // ğŸš© JSON ì˜¤ë¥˜ í•´ê²°: ë¹ˆ ì‘ë‹µ ë° ì—ëŸ¬ ì²˜ë¦¬ë¥¼ ê°•í™”í•œ checkAuth
    async function checkAuth() {
        try {
            const res = await fetch(`https://${SERVER_URL}/api/me`);
            if (res.ok) {
                const text = await res.text();
                if (!text) return; // ë‚´ìš©ì´ ì—†ìœ¼ë©´ ì¤‘ë‹¨

                const user = JSON.parse(text);
                if (user && user.nickname) {
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    if (user.role === 'ADMIN') document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                    connectChat(user.nickname, user.role);
                    loadLeaderboard(); loadMatches();
                }
            }
        } catch (e) {
            console.log("ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ");
        }
    }

    async function guestLogin() {
        const n = document.getElementById('nickInput').value;
        if(!n) return alert("ë‹‰ë„¤ì„ ì…ë ¥!");
        await fetch(`https://${SERVER_URL}/api/login/guest?nickname=${encodeURIComponent(n)}`, { method: 'POST' });
        checkAuth();
    }

    async function adminLogin() {
        const id = document.getElementById('adminId').value;
        const pw = document.getElementById('adminPw').value;
        const res = await fetch(`https://${SERVER_URL}/api/login/admin?loginId=${id}&password=${pw}`, { method: 'POST' });
        if (res.ok) checkAuth(); else alert("ì•„ì´ë””/ë¹„ë²ˆ í‹€ë¦¼");
    }

    function logout() { fetch(`https://${SERVER_URL}/api/logout`, {method:'POST'}).then(()=>location.reload()); }
    async function resetAll() { if (confirm("ë°ì´í„°ë¥¼ ì™„ì „ ì´ˆê¸°í™”í• ê¹Œìš”?")) { await fetch(`https://${SERVER_URL}/reset-all`); location.reload(); } }
    async function genSchedule() { const res = await fetch(`https://${SERVER_URL}/generate-schedule`); alert(await res.text()); loadMatches(); }

    setInterval(() => {
        if (document.getElementById('main-content').style.display === 'block') {
            loadLeaderboard();
            const adminTab = document.getElementById('admin-tab');
            if (adminTab && adminTab.style.display === 'block') loadMatches();
        }
    }, 5000);

    setInterval(() => { fetch(`https://${SERVER_URL}/api/me`).catch(() => {}); }, 600000);

    window.onload = checkAuth;
    document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMsg(); });
</script>
</body>
</html>